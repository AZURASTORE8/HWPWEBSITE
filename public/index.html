<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HORWONG SCHOOL</title>
  <link rel="icon" href="https://hwp.ac.th/wp-content/uploads/2021/08/logo_hwp_y-300x300.png" type="image/png">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="loading"><div class="spinner"></div></div>

  <!-- Admin Panel moved above header -->
  <div id="adminPanel" style="display:none; margin-bottom:20px; text-align:right;">
    <div class="grid">
      <button class="btn" id="openAddRoomModalBtn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
    </div>
  </div>

  <header>
    <div class="logo"><img src="https://hwp.ac.th/wp-content/uploads/2021/08/logo_hwp_y-300x300.png" alt="Logo"/></div>
    <div class="title">
      <h1>HORWONG SCHOOL ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</h1>
      <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏∂‡∏Å/‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á</p>
    </div>
  </header>

  <main>
    <aside class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏∂‡∏Å</strong>
        <button class="btn" id="resetBtn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
      </div>
      <div class="search">
        <select id="buildingSelect">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏∂‡∏Å --</option>
          <option value="1">‡∏ï‡∏∂‡∏Å 1</option>
          <option value="2">‡∏ï‡∏∂‡∏Å 2</option>
          <option value="3">‡∏ï‡∏∂‡∏Å 3</option>
          <option value="4">‡∏ï‡∏∂‡∏Å 4</option>
          <option value="5">‡∏ï‡∏∂‡∏Å 5</option>
        </select>
      </div>
      <div class="search"><input id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏∂‡∏Å..." /></div>
      <div class="room-list" id="roomList"></div>
    </aside>

    <section class="board">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 id="selectedRoomTitle">Welcome To Horwong School</h3>
            <div class="muted" id="selectedRoomDesc">‡πÄ‡∏ä‡πá‡∏Ñ‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏•‡∏¢</div>
          </div>
          <div class="controls">
            <select id="daySelect"><option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô --</option></select>
          </div>
        </div>
        <div style="margin-top:12px">
          <strong>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 9 ‡∏Ñ‡∏≤‡∏ö (08:00 - 15:30)</strong>
          <p class="muted" style="font-size:12px;margin-top:4px;display:block">* Version Beta Test *</p>
          <div class="availability" id="slotsArea" style="margin-top:8px"></div>
        </div>
      </div>
    </section>
  </main>
    <!-- Admin mode badge -->
    <div class="admin-badge" id="adminBadge" data-active="false">üõ°Ô∏è Admin Mode</div>
    <!-- Discord Chat -->
    <div class="chat-wrapper">
      <button id="chatBtn" class="messenger-btn" title="‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô">
        <img src="https://cdn-icons-png.flaticon.com/128/9068/9068693.png" alt="Messenger" />
      </button>
  
      <div id="chatPopup" class="chat-popup">
        <div class="chat-header" id="chatHeader"><span>‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô Discord</span></div>
        <div class="chat-body" id="chatBody"></div>
        <div class="chat-footer">
          <!-- Section 1: Register email -->
          <div id="emailSection">
            <input type="text" id="emailInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." required />
            <button id="startChatBtn" class="icon-btn" aria-label="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢">
              <img src="https://cdn-icons-png.flaticon.com/512/6543/6543039.png" alt="Start" />
            </button>
          </div>
          <!-- Section 2: Chat after registration -->
          <div id="chatSection" style="display:none">
            <input type="text" id="chatInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." />
            <button id="sendMsgBtn" class="icon-btn" aria-label="‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°">
              <img src="https://cdn-icons-png.flaticon.com/512/3682/3682321.png" alt="Send" />
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Add Room Modal -->
    <div class="modal-backdrop" id="addRoomModal">
      <div class="modal">
        <div class="modal-header">
          ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
          <button class="btn secondary" id="closeAddRoomModalBtn">‡∏õ‡∏¥‡∏î</button>
        </div>
        <div class="modal-body">
          <input id="modalRoomId" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô 301)" />
          <input id="modalRoomDesc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÄ‡∏ä‡πà‡∏ô Smart Classroom)" />
          <select id="modalRoomBuilding">
            <option value="1">‡∏ï‡∏∂‡∏Å 1</option>
            <option value="2">‡∏ï‡∏∂‡∏Å 2</option>
            <option value="3">‡∏ï‡∏∂‡∏Å 3</option>
            <option value="4">‡∏ï‡∏∂‡∏Å 4</option>
            <option value="5">‡∏ï‡∏∂‡∏Å 5</option>
          </select>
        </div>
        <div class="modal-actions">
          <button class="btn secondary" id="cancelAddRoomBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn" id="confirmAddRoomBtn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á</button>
        </div>
      </div>
    </div>
  <!-- ====== SCRIPT ====== -->
  <script>
    // ====== ‡∏´‡πâ‡∏≠‡∏á ======
    const sampleRooms=[
      // Building 1
      {id:'131',name:'‡∏´‡πâ‡∏≠‡∏á 131',desc:'HORWONG SCHOOL',building:'1'},
      {id:'132',name:'‡∏´‡πâ‡∏≠‡∏á 132',desc:'HORWONG SCHOOL',building:'1'},
      {id:'134',name:'‡∏´‡πâ‡∏≠‡∏á 134',desc:'HORWONG SCHOOL',building:'1'},
      {id:'135',name:'‡∏´‡πâ‡∏≠‡∏á 135',desc:'HORWONG SCHOOL',building:'1'},
      {id:'141',name:'‡∏´‡πâ‡∏≠‡∏á 141',desc:'‡∏ß‡∏¥‡∏ó‡∏¢‡πå-‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',building:'1'},
      // Building 2
      {id:'212',name:'‡∏´‡πâ‡∏≠‡∏á 212',desc:'HORWONG SCHOOL',building:'2'},
      {id:'213',name:'‡∏´‡πâ‡∏≠‡∏á 213',desc:'HORWONG SCHOOL',building:'2'},
      {id:'214',name:'‡∏´‡πâ‡∏≠‡∏á 214',desc:'HORWONG SCHOOL',building:'2'},
      {id:'221',name:'‡∏´‡πâ‡∏≠‡∏á 221',desc:'‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©',building:'2'},
      // Building 3
      {id:'301',name:'‡∏´‡πâ‡∏≠‡∏á 301',desc:'‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å',building:'3'},
      {id:'302',name:'‡∏´‡πâ‡∏≠‡∏á 302',desc:'‡∏î‡∏ô‡∏ï‡∏£‡∏µ',building:'3'},
      {id:'303',name:'‡∏´‡πâ‡∏≠‡∏á 303',desc:'‡∏®‡∏¥‡∏•‡∏õ‡∏∞',building:'3'},
      // Building 4
      {id:'401',name:'‡∏´‡πâ‡∏≠‡∏á 401',desc:'‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏¢‡πà‡∏≠‡∏¢',building:'4'},
      {id:'402',name:'‡∏´‡πâ‡∏≠‡∏á 402',desc:'‡∏´‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á',building:'4'},
      // Building 5
      {id:'501',name:'‡∏´‡πâ‡∏≠‡∏á 501',desc:'Smart Classroom',building:'5'},
      {id:'502',name:'‡∏´‡πâ‡∏≠‡∏á 502',desc:'Smart Lab',building:'5'}
    ];
    let selectedRoom=null; 
    let selectedDay='‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå';
    let isAdmin=false;

    const ADMIN_PASSWORD="admin123"; // ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô

    const roomStatus={ 
      '131': {'‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå':[true,false,true,true,false,true,true,false,true]},
      '132': {'‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå':[true,true,false,false,true,false,true,true,false]},
      '134': {'‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå':[false,true,true,false,true,true,false,true,true]},
      '135': {'‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå':[true,false,false,true,true,false,true,false,true]},
      '212': {'‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå':[true,true,true,false,false,true,false,true,true]},
      '213': {'‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå':[false,true,false,true,true,false,true,false,true]},
      '214': {'‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå':[true,false,true,false,true,true,false,true,false]} 
    };

    const roomListEl=document.getElementById('roomList');
    const selectedRoomTitle=document.getElementById('selectedRoomTitle');
    const selectedRoomDesc=document.getElementById('selectedRoomDesc');
    const buildingSelect=document.getElementById('buildingSelect');
    const searchInput=document.getElementById('searchInput');
    const slotsArea=document.getElementById('slotsArea');
    const daySelect=document.getElementById('daySelect');
    const resetBtn=document.getElementById('resetBtn');
    const loadingEl=document.getElementById('loading');
    const adminPanel=document.getElementById('adminPanel');
    const adminBadge=document.getElementById('adminBadge');

    // Modal elements
    const addRoomModal=document.getElementById('addRoomModal');
    const openAddRoomModalBtn=document.getElementById('openAddRoomModalBtn');
    const closeAddRoomModalBtn=document.getElementById('closeAddRoomModalBtn');
    const cancelAddRoomBtn=document.getElementById('cancelAddRoomBtn');
    const confirmAddRoomBtn=document.getElementById('confirmAddRoomBtn');
    const modalRoomId=document.getElementById('modalRoomId');
    const modalRoomDesc=document.getElementById('modalRoomDesc');
    const modalRoomBuilding=document.getElementById('modalRoomBuilding');

    const weekdays=['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå'];
    weekdays.forEach(d=>{const opt=document.createElement('option'); opt.value=d; opt.textContent=d; daySelect.appendChild(opt);});
    daySelect.value='‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå';

    function showLoading(){ loadingEl.style.display='flex'; }
    function hideLoading(){ setTimeout(()=>loadingEl.style.display='none',100); }

    function renderRooms(){
      showLoading();
      roomListEl.innerHTML='';
      const filterText=searchInput.value.trim().toLowerCase();
      const building=buildingSelect.value;
      sampleRooms.filter(r=>{
        if(building && r.building!==building) return false;
        if(!filterText) return true;
        return r.name.toLowerCase().includes(filterText)||(r.desc||'').toLowerCase().includes(filterText);
      }).forEach(r=>{
        const div=document.createElement('div');
        div.className='room-item';
        div.dataset.id=r.id;
        div.innerHTML=`<div class="thumb">${r.building}</div><div class="meta"><h4>${r.name}</h4><p class="muted">${r.desc}</p></div>`;
        div.addEventListener('click',()=>{ selectRoom(r.id); document.querySelectorAll('.room-item').forEach(x=>x.dataset.selected=false); div.dataset.selected=true; });
        roomListEl.appendChild(div);
      });
      hideLoading();
    }

    function selectRoom(id){
      showLoading();
      selectedRoom=sampleRooms.find(r=>r.id===id);
      selectedRoomTitle.textContent=selectedRoom.name;
      selectedRoomDesc.textContent=selectedRoom.desc;
      renderSlots();
      hideLoading();
    }

    function renderSlots(){
      slotsArea.style.opacity=0;
      slotsArea.innerHTML='';
      if(!selectedRoom){ slotsArea.innerHTML='<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</div>'; slotsArea.style.opacity=1; return; }
      if(!selectedDay){ slotsArea.innerHTML='<div class="muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏®‡∏∏‡∏Å‡∏£‡πå</div>'; slotsArea.style.opacity=1; return; }

      const slots=[{time:'08:00'},{time:'08:50'},{time:'09:40'},{time:'10:30'},{time:'11:20'},{time:'12:10'},{time:'13:00'},{time:'13:50'},{time:'14:40'}];

      if(!roomStatus[selectedRoom.id]) roomStatus[selectedRoom.id]={};
      if(!roomStatus[selectedRoom.id][selectedDay]) roomStatus[selectedRoom.id][selectedDay]=new Array(slots.length).fill(false);
      // Create Morning Group
      const morningGroup=document.createElement('div');
      morningGroup.className='slot-group';
      const morningTitle=document.createElement('h4');
      morningTitle.textContent='‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤';
      const morningContainer=document.createElement('div');
      morningContainer.className='slot-container';
      morningGroup.appendChild(morningTitle);
      morningGroup.appendChild(morningContainer);

      // Create Afternoon Group
      const afternoonGroup=document.createElement('div');
      afternoonGroup.className='slot-group';
      const afternoonTitle=document.createElement('h4');
      afternoonTitle.textContent='‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢';
      const afternoonContainer=document.createElement('div');
      afternoonContainer.className='slot-container afternoon-container';
      afternoonGroup.appendChild(afternoonTitle);
      afternoonGroup.appendChild(afternoonContainer);

      // Build slot elements and add to the correct group
      slots.forEach((s,i)=>{
        const el=document.createElement('div');
        const free=roomStatus[selectedRoom.id][selectedDay][i];
        const baseClass='slot ' + (free?'free':'busy');
        // Morning: index 0-4 (08:00 - 11:20), Afternoon: index 5-8 (12:10 - 14:40)
        if(i<=4){
          el.className=baseClass;
        }else{
          el.className=baseClass+' afternoon-slot';
        }
        el.innerHTML=`<div>${s.time}</div><div class="status">${free?'‡∏ß‡πà‡∏≤‡∏á':'‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á'}</div>`;
        if(isAdmin){
          el.style.cursor='pointer';
          el.addEventListener('click',()=>{
            roomStatus[selectedRoom.id][selectedDay][i]=!roomStatus[selectedRoom.id][selectedDay][i];
            renderSlots();
          });
        }
        if(i<=4){
          morningContainer.appendChild(el);
        }else{
          afternoonContainer.appendChild(el);
        }
      });

      // Append groups to main area
      slotsArea.appendChild(morningGroup);
      slotsArea.appendChild(afternoonGroup);
      setTimeout(()=>{slotsArea.style.opacity=1},100);
    }

    daySelect.addEventListener('change',()=>{ selectedDay=daySelect.value; renderSlots(); });
    resetBtn.addEventListener('click',()=>{
      buildingSelect.value=''; searchInput.value=''; selectedRoom=null; selectedDay='‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå';
      selectedRoomTitle.textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á'; selectedRoomDesc.textContent='‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà';
      daySelect.value='‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå'; slotsArea.innerHTML=''; renderRooms();
    });
    buildingSelect.addEventListener('change',renderRooms);
    searchInput.addEventListener('input',renderRooms);
    renderRooms();

  // ===== Discord Chat =====
  const chatBtn = document.getElementById('chatBtn');
  const chatPopup = document.getElementById('chatPopup');
  const chatHeader = document.getElementById('chatHeader');
  const chatBody = document.getElementById('chatBody');
  const emailSection = document.getElementById('emailSection');
  const chatSection = document.getElementById('chatSection');
  const chatInput = document.getElementById('chatInput');
  const emailInput = document.getElementById('emailInput');
  const startChatBtn = document.getElementById('startChatBtn');
  const sendMsgBtn = document.getElementById('sendMsgBtn');

  let ws = null;
  let isEmailLocked = false;

  function addMessage(msg, sender = 'admin') {
    const div = document.createElement('div');
    div.className = 'message ' + (sender === 'admin' ? 'admin' : 'user');
    
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    
    if (sender !== 'admin' && sender !== 'user') {
      // Message from Discord user
      const senderName = document.createElement('div');
      senderName.className = 'message-sender';
      senderName.textContent = sender;
      messageContent.appendChild(senderName);
    }
    
    const text = document.createElement('div');
    text.className = 'message-text';
    text.textContent = msg;
    messageContent.appendChild(text);
    
    div.appendChild(messageContent);
    chatBody.appendChild(div);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  // ===== Chat history (persist to localStorage per email) =====
  function historyKey(email) { return `chatHistory:${email}`; }

  function saveMessageToHistory(email, entry) {
    try {
      const key = historyKey(email);
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.push(entry);
      localStorage.setItem(key, JSON.stringify(arr));
    } catch (e) { console.error('Failed saving history', e); }
  }

  function loadHistory(email) {
    try {
      const key = historyKey(email);
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }

  function renderHistory(email) {
    const items = loadHistory(email);
    if (!items.length) return;
    chatBody.innerHTML = '';
    for (const it of items) {
      addMessage(it.message, it.sender);
    }
  }

  function connectWebSocket(email) {
    if (ws) {
      if (ws.readyState === WebSocket.OPEN) return;
      ws.close(); // Close existing connection if it exists but not open
    }
    
    // Connect to WebSocket server
    ws = new WebSocket(`ws://${window.location.host}`);
    
    ws.onopen = () => {
      console.log('Connected to chat server');
      // Register this connection with the user's email
      ws.send(JSON.stringify({
        type: 'register',
        email: email
      }));
      // Lock and persist email
      emailInput.disabled = true;
      isEmailLocked = true;
      localStorage.setItem('chatEmail', email);
      // Switch UI to chat section
      emailSection.style.display = 'none';
      chatSection.style.display = '';
      chatInput.focus();

      // Render previous history for this email
      renderHistory(email);
    };
    
    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        switch (data.type) {
          case 'message':
            // Always show Discord-side replies as 'admin'
            addMessage(data.message, 'admin');
            // Persist incoming message as 'admin'
            const eml = localStorage.getItem('chatEmail');
            if (eml) {
              saveMessageToHistory(eml, {
                sender: 'admin',
                message: data.message,
                timestamp: data.timestamp || new Date().toISOString()
              });
            }
            break;
          case 'error':
            console.error('Server error:', data.message);
            addMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.message}`, 'admin');
            break;
          default:
            console.log('Unknown message type:', data);
        }
      } catch (e) {
        console.error('Error parsing message:', e);
      }
    };
    
    ws.onclose = () => {
      console.log('Disconnected from chat server');
      if (isEmailLocked) {
        addMessage('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà', 'admin');
      }
    };
    
    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
      addMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'admin');
    };
  }

  // Handle chat button click
  chatBtn.addEventListener('click', () => {
    const isVisible = chatPopup.style.display === 'flex';
    chatPopup.style.display = isVisible ? 'none' : 'flex';
    
    if (!isVisible) {
      // Show chat popup
      if (chatBody.children.length === 0) {
        const savedEmail = localStorage.getItem('chatEmail');
        if (!savedEmail) {
          addMessage('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô', 'admin');
        }
      }
      
      // Focus on the appropriate input
      if (isEmailLocked) {
        chatInput.focus();
      } else {
        emailInput.focus();
      }

      // Auto-connect if email previously saved
      const savedEmail = localStorage.getItem('chatEmail');
      if (savedEmail && !isEmailLocked) {
        emailInput.value = savedEmail;
        emailInput.disabled = true;
        isEmailLocked = true;
        emailSection.style.display = 'none';
        chatSection.style.display = '';
        connectWebSocket(savedEmail);
      }
    }
  });

  // Toggle chat popup when clicking header
  chatHeader.addEventListener('click', () => {
    chatPopup.style.display = chatPopup.style.display === 'flex' ? 'none' : 'flex';
  });

  // Handle start chat (register email)
  startChatBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    if (!email) return addMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢', 'admin');
    if (!validateEmail(email)) return addMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'admin');
    connectWebSocket(email);
  });

  // Handle send message button click
  sendMsgBtn.addEventListener('click', sendMessage);
  
  // Handle Enter key in message input
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
  
  // Handle Enter key in email input
  emailInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && emailInput.value.trim()) {
      const email = emailInput.value.trim();
      if (validateEmail(email)) {
        connectWebSocket(email);
        chatInput.focus();
      } else {
        addMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'admin');
      }
    }
  });
  
  function sendMessage() {
    const email = emailInput.value.trim();
    const msg = chatInput.value.trim();
    
    if (!msg) return; // Don't send empty messages
    
    if (!isEmailLocked) {
      // First message - validate and connect
      if (!email) {
        addMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', 'admin');
        emailInput.focus();
        return;
      }
      
      if (!validateEmail(email)) {
        addMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'admin');
        emailInput.focus();
        return;
      }
      
      // Connect with the provided email
      connectWebSocket(email);
    }
    
    // If we're connected, send the message
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({
        type: 'message',
        message: msg,
        sender: 'user',
        timestamp: new Date().toISOString()
      }));
      
      // Add message to chat UI
      addMessage(msg, 'user');
      // Persist outgoing message
      const eml = localStorage.getItem('chatEmail') || email;
      if (eml) {
        saveMessageToHistory(eml, {
          sender: 'user',
          message: msg,
          timestamp: new Date().toISOString()
        });
      }
      
      // Clear input and keep focus
      chatInput.value = '';
      chatInput.focus();
    } else {
    }
  }
  
  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }

  // Initialize UI state based on persisted email
  (function initChatUI() {
    const savedEmail = localStorage.getItem('chatEmail');
    if (savedEmail) {
      emailInput.value = savedEmail;
      emailInput.disabled = true;
      isEmailLocked = true;
      emailSection.style.display = 'none';
      chatSection.style.display = '';
      // Render previous messages immediately
      renderHistory(savedEmail);
    }
  })();
  
    // ============ ADMIN MODE ============
    document.addEventListener('keydown',(e)=>{
      if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='a'){
        if(!isAdmin){
          const input=prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:");
          if(input===ADMIN_PASSWORD){
            isAdmin=true;
            alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          }else{
            alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î!");
            return;
          }
        }else{
          isAdmin=false;
          alert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
        }
        adminPanel.style.display=isAdmin?'block':'none';
        adminBadge.dataset.active = isAdmin ? 'true' : 'false';
        renderSlots();
      }
    });

    // ===== Add Room Modal Logic =====
    function openAddRoomModal(){
      modalRoomId.value='';
      modalRoomDesc.value='';
      modalRoomBuilding.value=buildingSelect.value || '1';
      addRoomModal.style.display='flex';
      setTimeout(()=>modalRoomId.focus(),50);
    }
    function closeAddRoomModal(){
      addRoomModal.style.display='none';
    }
    if(openAddRoomModalBtn){ openAddRoomModalBtn.addEventListener('click', openAddRoomModal); }
    if(closeAddRoomModalBtn){ closeAddRoomModalBtn.addEventListener('click', closeAddRoomModal); }
    if(cancelAddRoomBtn){ cancelAddRoomBtn.addEventListener('click', closeAddRoomModal); }
    addRoomModal.addEventListener('click',(e)=>{ if(e.target===addRoomModal) closeAddRoomModal(); });
    // Enter to confirm in modal
    [modalRoomId, modalRoomDesc].forEach(inp=>{
      inp.addEventListener('keypress',(e)=>{ if(e.key==='Enter'){ confirmAddRoomBtn.click(); }});
    });
    confirmAddRoomBtn.addEventListener('click',()=>{
      const id=modalRoomId.value.trim();
      const name=id ? `‡∏´‡πâ‡∏≠‡∏á ${id}` : '';
      const desc=modalRoomDesc.value.trim();
      const building=modalRoomBuilding.value;
      if(!id){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á'); return; }
      // Prevent duplicate IDs
      if(sampleRooms.some(r=>r.id===id)){
        alert('‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
        return;
      }
      sampleRooms.push({id,name,desc,building});
      // If a building is chosen, filter to it
      buildingSelect.value = building;
      renderRooms();
      // Auto-select newly added room
      selectRoom(id);
      alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      closeAddRoomModal();
    });
  </script>
</body>
</html>
